<!DOCTYPE html>
<!--
  Game Title: NeonBeat
  Author: CurryTarou Works
  GitHub: https://currytarou.github.io/neonbeat-by-currytarouworks/
  Copyright (c) 2026 CurryTarou Works. All rights reserved.
  License: MIT
-->
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <title>NEONBEAT-Rhythm game-v9.2</title>
    <meta name="description" content="Early Access rhythm game with dynamically generated note charts for any music.">
    <style>
	/* @preserve NeonBeat Styles | (c) 2026 CurryTarou Works */
        /* =========================================
           1. 全域與 PC 版基礎設定
           ========================================= */
        :root {
            --neon-blue: #00f3ff;
            --neon-pink: #ff0055;
            --neon-gold: #ffcc00;
            --neon-red: #ff3333;
            --bg-color: #050505;
        }
        
        body, html { margin: 0; padding: 0; background: var(--bg-color); color: #fff; font-family: 'Segoe UI', sans-serif; overflow: hidden; user-select: none; touch-action: none; -webkit-touch-callout: none; -webkit-user-select: none; }

        /* 背景層 */
        #bg-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0;
            background: #000; overflow: hidden;
        }
        #bg-video {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            min-width: 100%; min-height: 100%; width: auto; height: auto;
            object-fit: cover; opacity: 0; filter: brightness(0.4) blur(0px); transition: opacity 0.5s;
            pointer-events: none; 
        }

        /* 遊戲主舞台 */
        #gear-stage {
            position: relative; z-index: 10; 
            width: 520px; 
            height: 100vh; margin: 0 auto;
            background: rgba(10, 15, 20, 0.6);
            border-left: 4px solid #333; border-right: 4px solid #333;
            box-shadow: 0 0 60px rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            background-image: linear-gradient(90deg, 
                transparent 24%, rgba(255,255,255,0.08) 25%, 
                transparent 26%, transparent 49%, rgba(255,255,255,0.08) 50%, 
                transparent 51%, transparent 74%, rgba(255,255,255,0.08) 75%, 
                transparent 76%);
            background-size: 100% 100%;
            transition: transform 0.1s ease-out, filter 0.5s ease-in-out;
            touch-action: none;
            will-change: transform, opacity;
            backface-visibility: hidden;
        }
        
        .fever-mode-active {
            box-shadow: 0 0 80px var(--neon-gold) !important;
            border-color: var(--neon-gold) !important;
            /* [效能優化] 移除手機端極度耗能的 box-shadow 動畫，保留靜態光暈即可 */
            /* animation: pulse-border 0.2s infinite alternate; */
        }
        @keyframes pulse-border { from { box-shadow: 0 0 50px var(--neon-gold); } to { box-shadow: 0 0 100px var(--neon-gold); } }

        canvas { display: block; width: 100%; height: 100%; }

        /* HUD (介面) */
        .hud { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        #song-title-display {
            position: absolute; top: 20px; left: 0; width: 100%; 
            display: flex; flex-direction: column; align-items: center; 
            z-index: 100; pointer-events: none;
        }
        #song-name-text { font-size: 1.2rem; font-weight: bold; text-shadow: 0 0 10px var(--neon-blue); }

        #song-progress-container {
            width: 100%; max-width: 520px; height: 4px; 
            background: rgba(255, 255, 255, 0.1); margin-top: 10px;
            border-radius: 2px; overflow: visible; 
            position: relative;
        }

        #song-progress-bar {
            width: 100%; 
            height: 100%; 
            background: var(--neon-blue);
            box-shadow: 0 0 10px var(--neon-blue); 
            transform-origin: left; 
            transform: scaleX(0);   
            will-change: transform; /* [效能優化] 提示瀏覽器 GPU 加速 */
        }
        
        /* 難度顯示 */
        #difficulty-display {
            position: absolute; 
            top: 10px; 
            left: 50%; transform: translateX(-50%);
            color: var(--neon-blue); font-weight: bold; font-size: 18px;
            letter-spacing: 2px; text-shadow: 0 0 10px var(--neon-blue);
            z-index: 101; pointer-events: none; width: 100%; text-align: center;
            display: none; 
        }

        /* 手機版暫停按鈕 */
        #mobile-pause-btn {
            position: fixed; 
            top: 20px; 
            right: 20px; 
            width: 40px; 
            height: 40px; 
            border: 2px solid var(--neon-blue); 
            background: rgba(0, 0, 0, 0.5); 
            border-radius: 50%; 
            z-index: 200; 
            display: none; 
            justify-content: center; 
            align-items: center; 
            pointer-events: auto; 
            cursor: pointer;
            backdrop-filter: blur(4px);
        }
        #mobile-pause-btn::before {
            content: "||";
            color: var(--neon-blue);
            font-weight: 900;
            font-size: 16px;
            text-shadow: 0 0 5px var(--neon-blue);
        }

        /* PC版 HUD */
        #hp-bar-wrap { 
            position: absolute; left: -20px; bottom: 20%; width: 12px; height: 60%; 
            background: #222; border: 1px solid #555; border-radius: 4px; overflow: hidden;
        }
        #hp-fill { 
            position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; 
            transform-origin: bottom;
            transform: scaleY(1);
            background: linear-gradient(to top, var(--neon-blue), #fff); 
            transition: transform 0.2s cubic-bezier(0.25, 1, 0.5, 1); 
            will-change: transform; /* [效能優化] */
        }

        #fever-wrap { 
            position: absolute; right: -20px; bottom: 20%; width: 12px; height: 60%; 
            background: #222; border: 1px solid #555; border-radius: 4px; overflow: hidden;
        }
        #fever-fill { 
            position: absolute; bottom: 0; left: 0; width: 100%; height: 100%;
            transform-origin: bottom;
            transform: scaleY(0); 
            background: var(--neon-gold); 
            box-shadow: 0 0 15px var(--neon-gold); 
            transition: transform 0.05s linear;
            will-change: transform; /* [效能優化] */
        }
        
        #fever-txt { 
            position: absolute; top: 70%; left: 50%; transform: translate(-50%, -50%); 
            width: 100%; text-align: center;
            color: var(--neon-gold); font-weight: 900; font-size: 50px; 
            opacity: 0; text-shadow: 0 0 30px var(--neon-gold); letter-spacing: 5px;
            pointer-events: none; z-index: 20;
            transition: opacity 0.3s ease-in-out, transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            will-change: opacity, transform; /* [效能優化] */
        }

        #combo-box { 
            display: none !important;
        }
        .show-combo { opacity: 1 !important; transition: opacity 0.1s !important; }

        #judge-txt {
            font-size: 54px; font-weight: 900; font-style: italic; text-align: center;
            transition: transform 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-shadow: 0 0 20px currentColor, 0 0 40px currentColor; letter-spacing: 2px;
        }
        #combo-num { font-size: 90px; font-weight: 900; line-height: 1; color: #fff; }
        #combo-lbl { font-size: 20px; letter-spacing: 8px; color: #888; font-weight: bold; }

        .key-row { position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: space-around; pointer-events: auto; }
        .key-cap { 
            width: 22%; text-align: center; font-size: 28px; font-weight: 900; color: #888; 
            padding: 10px 0; transition: all 0.05s;
        }
        .key-cap.active { 
            color: #000; border-color: #fff; 
            background: var(--neon-blue); box-shadow: 0 0 25px var(--neon-blue);
            transform: translateY(2px);
        }

        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.94); z-index: 999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            backdrop-filter: blur(10px);
        }
        .hidden { display: none !important; }

        h1 { 
            font-size: 100px; 
            color: var(--neon-blue); margin-bottom: 30px; 
            text-transform: uppercase; letter-spacing: 10px; 
            text-shadow: 0 0 30px var(--neon-blue); font-style: italic;
            white-space: nowrap; 
            text-align: center;
        }

        .btn-group { display: flex; gap: 30px; margin-top: 30px; justify-content: center; position: relative; z-index: 2; }
        
        button {
            padding: 15px 40px; font-size: 20px; font-weight: 800; color: #fff; background: transparent;
            border: 2px solid var(--neon-blue); cursor: pointer; text-transform: uppercase; letter-spacing: 2px;
            transition: all 0.2s;
        }
        button:hover { background: var(--neon-blue); color: #000; box-shadow: 0 0 40px var(--neon-blue); transform: scale(1.1); }

        .file-zone { display: flex; gap: 40px; margin-bottom: 30px; }
        .file-box { 
            border: 2px dashed #555; padding: 40px; width: 240px; text-align: center; 
            border-radius: 15px; cursor: pointer; transition: 0.3s; 
        }
        .file-box:hover { border-color: var(--neon-blue); background: rgba(0,243,255,0.1); }
        .file-box label { cursor: pointer; display: block; width: 100%; height: 100%; color: #888; font-size: 16px; font-weight: bold; }
        .file-box.selected { border-color: var(--neon-blue); background: rgba(0, 243, 255, 0.15); box-shadow: 0 0 20px rgba(0, 243, 255, 0.4); }
        input[type="file"] { display: none; }
        .setting-zone { margin-bottom: 20px; color: #aaa; font-size: 18px; display: flex; align-items: center; gap: 10px; }
        input[type="checkbox"] { transform: scale(1.5); accent-color: var(--neon-blue); cursor: pointer; }

        /* 結果畫面 (PC) */
        #cd-num { font-size: 180px; font-weight: 900; color: #fff; text-shadow: 0 0 60px var(--neon-blue); }
        #res-rank { font-size: 160px; font-weight: 900; margin: 10px 0; /* text-shadow will be set by JS */ }
        .stats-table { display: grid; grid-template-columns: 1fr 1fr; gap: 10px 40px; text-align: left; margin: 20px 0; font-size: 24px; color: #ccc; }
        .fc-animation { font-size: 2rem; font-weight: bold; text-align: center; text-shadow: 0 0 10px #ffd700, 0 0 20px #ff8c00; animation: pulse 1s infinite alternate; }
        @keyframes pulse { from { transform: scale(1); opacity: 0.8; } to { transform: scale(1.1); opacity: 1; } }
        .bar-container { width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; margin-bottom: 10px; overflow: hidden; }
        .bar { height: 100%; width: 0%; transition: width 1s ease-out; }
        .chart-label { font-size: 0.8rem; display: flex; justify-content: space-between; margin-bottom: 2px; }
        .stat-chart { width: 100%; max-width: 400px; }
        .stat-item { display: flex; justify-content: space-between; width: 100%; max-width: 400px; font-size: 20px; }

        /* 光柱特效 */
        .diff-light-pillar {
            position: fixed;
            left: 50%;
            bottom: -300px; 
            transform: translateX(-50%);
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, rgba(0, 243, 255, 0.5), rgba(0, 243, 255, 0) 90%);
            filter: blur(30px);
            z-index: 1; 
            pointer-events: none;
            animation: glow-breathe 2.5s ease-in-out infinite alternate;
        }

        @keyframes glow-breathe {
            50% { opacity: 0.5; height: 400px; width: 400px; filter: blur(5px); }
            100% { opacity: 0.5; height: 500px; width: 500px; filter: blur(8px); }
        }

        .light-pillar-wrapper {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            overflow: hidden;
            pointer-events: none;
        }

        /* =========================================
           2. 手機版 RWD 覆寫設定 (螢幕 < 768px)
           ========================================= */
        @media (max-width: 768px) {
            #gear-stage { 
                width: 100%; max-width: 100%; border-left-width: 2px; border-right-width: 2px; 
                box-sizing: border-box; 
                backdrop-filter: none;
                background-color: rgba(10, 15, 20, 0.85);
            }

            #mobile-pause-btn { display: flex; }
            #box-video { display: none !important; }

            #song-title-display {
                width: 90%; 
                left: 5%;
            }
            #song-name-text {
                max-width: 100%;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            h1 { 
                font-size: 13vw; 
                letter-spacing: 2px;
                margin-bottom: 20px;
                white-space: nowrap; 
                padding-left: 10px; 
                padding-right: 10px;
                box-sizing: border-box;
            }

            #result-screen {
                padding-left: 20px;
                padding-right: 20px;
                box-sizing: border-box;
            }

            #judge-txt { font-size: 36px; will-change: transform, opacity; backface-visibility: hidden;} 
            #combo-num { font-size: 60px; } 
            #combo-lbl { font-size: 14px; }
            #fever-txt { font-size: 30px; letter-spacing: 2px; top: 60%; } 

            #hp-bar-wrap { left: 2px; bottom: 25%; width: 6px; height: 50%; border-color: rgba(255,255,255,0.3); }
            #fever-wrap { right: 2px; bottom: 25%; width: 6px; height: 50%; border-color: rgba(255,255,255,0.3); }

            #song-progress-container { width: 100%; }
            #difficulty-display { font-size: 16px; top: 15px; }

            .file-zone { 
                flex-direction: column; align-items: center; gap: 15px; 
                width: 100%; 
            }
            .file-box { 
                width: 100%; 
                padding: 20px; 
                box-sizing: border-box; 
            }
            
            .btn-group { flex-wrap: wrap; justify-content: center; gap: 10px; }
            button { padding: 10px 20px; font-size: 16px; min-width: 100px; }

            .key-row { 
                bottom: 8vh !important; 
                height: 14vh !important; 
                align-items: flex-end; 
                padding-bottom: 0;
            }
            .key-cap { 
                width: 24.5%; 
                height: 100%; 
                display: flex; align-items: flex-end; justify-content: center; 
                padding-bottom: 15px; 
                border-bottom: 4px solid rgba(255,255,255,0.1);
                background: linear-gradient(to top, rgba(255,255,255,0.05), transparent);
            }
            .key-cap.active { border-bottom-color: #fff; background: linear-gradient(to top, var(--neon-blue), transparent); box-shadow: none !important;}

            #cd-num { font-size: 40vw; }
            #res-rank { font-size: 30vw; }
        }

        .setting-item {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 10px 0;
        }

        @media (max-width: 600px) {
            .setting-item {
                flex-direction: column; 
                align-items: flex-start; 
            }
        }

        .neon-slider {
            -webkit-appearance: none;
            width: 150px;
            height: 6px;
            background: #222;
            border: 1px solid var(--neon-blue);
            border-radius: 5px;
            outline: none;
            box-shadow: 0 0 10px var(--neon-blue);
        }

        .neon-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: #fff;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 15px var(--neon-blue);
        }

        #volume-display {
            min-width: 40px;
            color: var(--neon-blue);
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        #offset-display {
            min-width: 40px;
            color: var(--neon-blue);
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <audio id="menu-bgm" loop>
        <source src="source/main-menu.mp3" type="audio/mpeg">
    </audio>
    <audio id="bgm-clear">
        <source src="source/stage-clear.mp3" type="audio/mpeg">
    </audio>
    <audio id="bgm-fail">
        <source src="source/game-over.mp3" type="audio/mpeg">
    </audio>

    <div id="bg-container">
        <video id="bg-video" playsinline webkit-playsinline muted loop></video>
    </div>

    <div id="mobile-pause-btn" onclick="playMenuImpact(); togglePause()"></div>

    <div id="song-title-display">
        <div id="song-name-text"></div>
        <div id="song-progress-container">
            <div id="song-progress-bar"></div>
            <div id="difficulty-display"></div>
        </div>
    </div>

    <div id="gear-stage">
        <canvas id="gameCanvas"></canvas>
        <div class="hud">
            <div id="hp-bar-wrap"><div id="hp-fill"></div></div>
            <div id="fever-wrap"><div id="fever-fill"></div></div>
            <div id="fever-txt">FEVER MAX!!</div>
            <div id="combo-box">
                <div id="judge-txt"></div>
                <div id="combo-num"></div>
                <div id="combo-lbl">COMBO</div>
            </div>
            <div class="key-row">
                <div class="key-cap" id="k0" data-key="0">D</div>
                <div class="key-cap" id="k1" data-key="1">F</div>
                <div class="key-cap" id="k2" data-key="2">J</div>
                <div class="key-cap" id="k3" data-key="3">K</div>
            </div>
        </div>
    </div>

<div id="menu-screen" class="overlay">
    <div id="start-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,1); z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer;">
        <h3 style="color:#fff; margin-top:-40px; margin-bottom: -30px;">Project</h3>
	<h1 style="margin-bottom:40px; font-size: 3rem; ">NEONBEAT</h1>
        <h3 style="color:#fff; margin-top:-40px; margin-bottom:20px;">SIGNATURE EDITION Early Access</h3>
	
        <h2 style="color: var(--neon-blue); text-shadow: 0 0 15px var(--neon-blue); font-size: 30px; letter-spacing: 5px; animation: pulse 1.5s infinite;">TAP TO START</h2>
        
	<p style="color: #888; letter-spacing: 1px; margin-top: 40px; padding-left-right: 20px;">Developed by CurryTarou</p>
	<p style="color: #888; letter-spacing: 1px; margin-top: -20px; padding-left-right: 20px;">with Google Gemini</p>
	<p style="color: #888; letter-spacing: 1px; margin-top: 0px;">© 2026 CurryTarou Works</p>
    </div>

    <div id="menu-main-content" style="visibility: hidden; width: 100%; display: flex; flex-direction: column; align-items: center; overflow-y: auto; max-height: 100vh; padding: 20px; box-sizing: border-box;">
	<h1 style="margin-bottom:30px;">NEONBEAT</h1>
        <h3 style="color:#fff; margin-top:-40px; margin-bottom:30px; text-align: center;">SIGNATURE EDITION</h3>
	
        <div class="file-zone">
            <div class="file-box" id="box-audio" onclick="handleBoxClick(event, 'audio')">
                <label id="label-audio" style="pointer-events: none;">
                    MUSIC MODE<br>(MP3/MP4/WAV)<br><br>
                    <span id="name-audio" style="color:var(--neon-blue)">Select File</span>
                </label>
                <input type="file" id="inp-audio" accept="audio/*, .mp3, .wav, .ogg, .m4a, .mp4" onchange="loadMedia(this.files[0], 'audio')">
            </div>
            <div class="file-box" id="box-video" onclick="handleBoxClick(event, 'video')">
                <label id="label-video" style="pointer-events: none;">
                    VIDEO MODE<br>(MP4/MOV)<br><br>
                    <span id="name-video" style="color:var(--neon-blue)">Select File</span>
                </label>
                <input type="file" id="inp-video" accept="video/*, .mp4, .webm" onchange="loadMedia(this.files[0], 'video')">
            </div>
        </div>

        <div id="diff-opt" style="display:none; text-align:center; width: 100%; position: relative;">
            <div class="light-pillar-wrapper">
    		<div class="diff-light-pillar"></div>
		</div>

            <div style="margin: -20px 0;">
                <span style="color: var(--neon-blue); margin-right: 10px;">SPEED:</span>
                <button class="diff-btn" onclick="changeSpeed(-1)" style="min-width: 40px; padding: 5px 10px;">-</button>
                <h2 id="speed-display" style="display: inline-block; width: 80px; text-align: center; font-size: 20px;">1.00x</h2>
                <button class="diff-btn" onclick="changeSpeed(1)" style="min-width: 40px; padding: 5px 10px;">+</button>
            </div>
            <p style="color:#888; margin-bottom:-20px; margin-top: 20px; letter-spacing:2px;">SELECT DIFFICULTY</p>
            <div class="btn-group">
                <button tabindex="-1" onmousedown="event.preventDefault()" onclick="playMenuImpact(); preInitGame(0.7)">EASY</button>
                <button tabindex="-1" onmousedown="event.preventDefault()" onclick="playMenuImpact(); preInitGame(1.0)">NORMAL</button>
                <button tabindex="-1" onmousedown="event.preventDefault()" onclick="playMenuImpact(); preInitGame(1.4)">HARD</button>
            </div>
        </div>
<p style="color:#888; margin-bottom: 0px; margin-top: 20px; letter-spacing:2px;">GAME SETTINGS</p>
<div class="setting-item" style="margin-bottom: 20px;">
    <span class="setting-label">VOLUME</span>
    <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="0.4" class="neon-slider ">
    <span id="volume-display">40%</span>

    <span class="setting-label">OFFSET</span>
    <input type="range" id="offset-slider" min="-0.2" max="0.2" step="0.005" value="0.0" class="neon-slider" >
    <span id="offset-display">0.000s</span>

</div>

        <div class="setting-zone" style="margin-bottom: 20px;">
            <input type="checkbox" id="chk-fail" checked>
            <label for="chk-fail">Enable Game Over</label>
        </div>
    </div>

	<span style="color:#fff; margin-top: 30px; margin-bottom:30px; text-align: center;">© 2026 CurryTarou Works</span>
</div>

    <div id="cd-screen" class="overlay hidden"><div id="cd-num">3</div></div>

    <div id="pause-screen" class="overlay hidden">
        <h1 style="color:#fff">PAUSED</h1>
        <div class="btn-group">
            <button onclick="playMenuImpact(); resumeGame()">RESUME</button>
            <button onclick="playMenuImpact(); retryGame()">RETRY</button>
            <button onclick="playMenuImpact(); backToMenu()">TITLE</button>
        </div>
    </div>

    <div id="result-screen" class="overlay hidden">
        <h1 id="res-title">STAGE CLEAR</h1>
        <div id="res-rank">S</div>
        <div id="res-fc" class="hidden fc-animation">FULL COMBO</div>
        
        <div class="stat-item">
            <span>MAX COMBO</span>
            <span id="st-max-combo" style="color: var(--neon-gold);">0</span>
        </div>

        <div class="stat-chart">
            <div class="chart-label">PERFECT <span id="st-perf">0</span></div>
            <div class="bar-container"><div id="bar-perf" class="bar" style="background: #ffeb3b;"></div></div>
            <div class="chart-label">GREAT <span id="st-great">0</span></div>
            <div class="bar-container"><div id="bar-great" class="bar" style="background: #00f3ff;"></div></div>
            <div class="chart-label">GOOD <span id="st-good">0</span></div>
            <div class="bar-container"><div id="bar-good" class="bar" style="background: #4caf50;"></div></div>
            <div class="chart-label">MISS <span id="st-miss">0</span></div>
            <div class="bar-container"><div id="bar-miss" class="bar" style="background: #f44336;"></div></div>
        </div>

        <div style="font-size:20px; color:#888; margin: 10px 0;">SCORE: <span id="res-score" style="color:#fff">0</span></div>
        <div class="btn-group">
            <button onclick="playMenuImpact(); retryGame()">PLAY AGAIN</button>
            <button onclick="playMenuImpact(); backToMenu()">TITLE</button>
        </div>
    </div>

<script>
/*!
   * @preserve NeonBeat Game Logic
   * Author: CurryTarou Works
   * License: MIT
   */
console.log("%c NeonBeat %c (c) 2026 CurryTarou Works ", "color: white; background: #2196f3; font-weight: bold;", "color: #2196f3;");
void 0;const IS_MOBILE=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),GAME_CONFIG={COLORS:{NOTE_LANES:["#ff0055","#ffffff","#ffffff","#ff0055"],NEON_BLUE:"#00f3ff",NEON_GOLD:"#ffcc00",NEON_RED:"#ff3333",LANE_WIDTH:130,NOTE_HEIGHT:26,HIT_SCALE:5},JUDGEMENT:{WINDOW_PERFECT:.06,WINDOW_GREAT:.1,WINDOW_GOOD:.16,HIT_DETECTION_RANGE:.35,MOBILE_HIT_WINDOW_SCALE:1.4,SCORE_PERFECT:500,SCORE_GREAT:300,SCORE_GOOD:100,HP_GAIN_PERFECT:1.5,HP_GAIN_GREAT:1,HP_GAIN_GOOD:.5,HP_LOSS_MISS:5,RELEASE_BUFFER:.2},SPEED:{BASE_TRAVEL_TIME:1.2,OPTIONS:[.75,1,1.25,1.5,1.75,2],FEVER_ACCEL:1.15,MOBILE_SCALE:1.5,MIN_DISPLAY_BPM:100},OFFSET:{MOBILE:0,DESKTOP:0},GENERATION:{GRID_SNAP:.09,MIN_COOLDOWN:.14,SMOOTHING:.96,PRESCAN_MIN_GAP:.12,DENSITY_CONTROL:{GLOBAL_LIMIT:1,KICK_CHANCE:1,MELODY_CHANCE:.7},LONG_NOTE_RULES:{CHANCE:.2,STABILITY_REQUIRED:1.3,DENSITY_THRESHOLD:3},FLOW_RULES:{ALLOW_OVERFLOW:!0,OVERFLOW_CHANCE:.4,STAIR_STEP:1},SENSITIVITY:{KICK:{threshold:3.5,multiplier:1.4,longNoteProb:.3,min_gap:.15},LEAD:{threshold:1.5,multiplier:1.1,longNoteProb:.45,min_gap:.1},AVG_UPDATE_RATE:.985}},AUDIO:{BPM_MIN:80,BPM_MAX:170,DEFAULT_BPM:120,FFT_SIZE:1024},FEVER:{MAX_VALUE:100,GAIN_PER_HIT:1.2,DRAIN_RATE:100/720,SCORE_MULTIPLIER:2,FILTER_MIN_FREQ:3e3,FILTER_MAX_FREQ:22e3,BASS_GAIN:6}};let G={screen:"MENU",mediaEl:null,mediaType:"none",playing:!1,paused:!1,animId:null,failEnabled:!0,hp:100,score:0,combo:0,maxCombo:0,fever:0,isFever:!1,feverTimer:null,stats:{perfect:0,great:0,good:0,miss:0,maxCombo:0},notes:[],particles:[],beams:[0,0,0,0],diff:1,baseSpeed:1,currentSpeed:1,scrollSpeedIndex:1,scrollSpeed:1,bpm:120,beatPoints:[],laneEndTime:[0,0,0,0],lastSpawn:0,energyAvg:0,avgLow:60,avgMid:50,prevLow:0,prevMid:0,activeLongNotes:[null,null,null,null],keysHeld:[!1,!1,!1,!1],lineGlow:0,comboTimer:null,audioOffset:0,baseOffset:IS_MOBILE?.3:.25,userOffset:0,lastLane:-1,consecutiveMelody:0,density:0,isResting:!1,smoothTime:0,lastFrameTime:0,menuFadeTimer:null,lastAnalysisTime:0,lastHudUpdate:{hp:-1,fever:-1,combo:-1},volume:.4,videoSourceNode:null,freqDataArray:null,cachedGradients:{fever:null,beams:[null,null,null,null]}};G.audioOffset=(IS_MOBILE,.2),G.userOffset=0,G.audioOffset=G.baseOffset+G.userOffset;const cvs=document.getElementById("gameCanvas"),ctx=cvs.getContext("2d");let CH=window.innerHeight,CW=window.innerWidth,SCALE_X=1,JUDGE_Y=.84*CH,touchStageRect=null;function resizeCanvas(){const e=document.getElementById("gear-stage");if(e){touchStageRect=e.getBoundingClientRect(),CW=e.clientWidth,CH=e.clientHeight,cvs.width=CW,cvs.height=CH,CW<520?(SCALE_X=CW/520,JUDGE_Y=.75*CH):(SCALE_X=1,JUDGE_Y=.84*CH),G.cachedGradients.fever=ctx.createLinearGradient(0,JUDGE_Y,0,0),G.cachedGradients.fever.addColorStop(0,"rgba(255, 204, 0, 0.4)"),G.cachedGradients.fever.addColorStop(1,"rgba(255, 204, 0, 0)");const t=GAME_CONFIG.COLORS.LANE_WIDTH*SCALE_X;for(let e=0;e<4;e++){const t=ctx.createLinearGradient(0,JUDGE_Y,0,0);t.addColorStop(0,GAME_CONFIG.COLORS.NOTE_LANES[e]),t.addColorStop(1,"transparent"),G.cachedGradients.beams[e]=t}}}window.onresize=resizeCanvas,window.onload=resizeCanvas;const AudioContext=window.AudioContext||window.webkitAudioContext,actx=new AudioContext,analyser=actx.createAnalyser();analyser.fftSize=GAME_CONFIG.AUDIO.FFT_SIZE;const masterGainNode=actx.createGain();masterGainNode.gain.value=.4,masterGainNode.connect(actx.destination);let mainSource=null,menuGainNode=null,menuSource=null,resultSource=null,resultGainNode=null,resultFadeTimer=null,clearSource=null,clearGain=null,failSource=null,failGain=null,feverBassNode=null,feverFilter=actx.createBiquadFilter();feverFilter.type="lowpass",feverFilter.frequency.value=GAME_CONFIG.FEVER.FILTER_MAX_FREQ;let noiseBuffer=null;function createNoiseBuffer(){const e=2*actx.sampleRate,t=actx.createBuffer(1,e,actx.sampleRate),n=t.getChannelData(0);for(let t=0;t<e;t++)n[t]=2*Math.random()-1;noiseBuffer=t}createNoiseBuffer();const sfxBus=actx.createGain();sfxBus.connect(masterGainNode);let sfxBuffers={hit:null,feverHit:null};async function preRenderSFX(){try{const e=window.OfflineAudioContext||window.webkitOfflineAudioContext;let t=new e(1,.1*actx.sampleRate,actx.sampleRate),n=t.createOscillator(),a=t.createGain();n.type="triangle",n.frequency.setValueAtTime(200,0),n.frequency.exponentialRampToValueAtTime(30,.1),a.gain.setValueAtTime(.8,0),a.gain.exponentialRampToValueAtTime(.001,.1),n.connect(a),a.connect(t.destination),n.start(0),n.stop(.1),sfxBuffers.hit=await t.startRendering();let i=new e(1,.2*actx.sampleRate,actx.sampleRate),o=i.createOscillator(),l=i.createGain();o.type="triangle",o.frequency.setValueAtTime(150,0),o.frequency.exponentialRampToValueAtTime(20,.2),l.gain.setValueAtTime(.8,0),l.gain.exponentialRampToValueAtTime(.001,.2),o.connect(l),l.connect(i.destination),o.start(0),o.stop(.2),sfxBuffers.feverHit=await i.startRendering()}catch(e){void 0}}function spawnNote(e,t,n=null){if(G.spawnFilterRate<1.05&&Math.random()>G.spawnFilterRate)return{isDummy:!0};let a=n;null===a&&(a="drum_heavy"===t?Math.random()>.5?0:3:Math.random()>.5?1:2);const i=G.scrollSpeed||1;let o=G.bpm||120;o<GAME_CONFIG.SPEED.MIN_DISPLAY_BPM&&(o=GAME_CONFIG.SPEED.MIN_DISPLAY_BPM);const l=Math.max(.5,o/120),s=IS_MOBILE?GAME_CONFIG.SPEED.MOBILE_SCALE:1,c=GAME_CONFIG.SPEED.BASE_TRAVEL_TIME/l*s,r={lane:a,time:e+c+0,endTime:e+c+.35/i,hit:!1,missed:!1,isLong:!1,isHolding:!1,type:t,spawnTime:e};return G.notes.push(r),r}async function preScanAudio(e){G.notes=[],G.laneEndTime=[0,0,0,0],G.lastEpicNoteTime=0;const t=e.getChannelData(0),n=e.sampleRate,a=e.duration-4;let i=.2,o=.2;const l=GAME_CONFIG.GENERATION.PRESCAN_MIN_GAP||.12,s=GAME_CONFIG.GENERATION.SENSITIVITY,c=.01*n;for(let e=0;e<t.length;e+=c){const c=e/n;if(c>a)break;let r=0,d=0,m=1024;for(let n=0;n<m&&e+n<t.length;n++){const a=Math.abs(t[e+n]||0);r+=a,d+=Math.abs(a-Math.abs(t[e+n-1]||0))}const u=r/m,E=d/m;let f=[],I=!1,T=0;if(IS_MOBILE&&(G.laneEndTime[0]>c&&T++,G.laneEndTime[1]>c&&T++,G.laneEndTime[2]>c&&T++,G.laneEndTime[3]>c&&T++),u>s.KICK.threshold/100&&u>i*s.KICK.multiplier){let e=Math.random()>.5?0:3;const t=Math.random()<s.KICK.longNoteProb&&c+1<a;let n=!0;if(IS_MOBILE&&(0===e&&f.includes(1)&&(n=!1),3===e&&f.includes(2)&&(n=!1),0===e&&G.laneEndTime[1]>c&&(n=!1),3===e&&G.laneEndTime[2]>c&&(n=!1),T>=2&&(n=!1)),n&&c>G.laneEndTime[e]+l){createNoteFromScan(c,e,t,"beat");let n=c+(t?.5:.2);G.laneEndTime[e]=n,IS_MOBILE&&(0===e&&(G.laneEndTime[1]=Math.max(G.laneEndTime[1],n+.05)),3===e&&(G.laneEndTime[2]=Math.max(G.laneEndTime[2],n+.05)),f.push(e)),I=!0,T++}}if(E>s.LEAD.threshold/100&&E>o*s.LEAD.multiplier){let e=Math.random()>.5?1:2;const t=Math.random()<s.LEAD.longNoteProb&&c+.5<a;let n=!0;if(IS_MOBILE&&(T>=2&&(n=!1),f.some(t=>Math.abs(t-e)<=1)&&(n=!1),1===e&&(G.laneEndTime[0]>c||G.laneEndTime[2]>c)&&(n=!1),2===e&&(G.laneEndTime[1]>c||G.laneEndTime[3]>c)&&(n=!1)),n&&c>G.laneEndTime[e]+l){createNoteFromScan(c,e,t,"melody");let n=c+(t?.5:.2);G.laneEndTime[e]=n,IS_MOBILE&&(1===e&&(G.laneEndTime[0]=Math.max(G.laneEndTime[0],n+.05),G.laneEndTime[2]=Math.max(G.laneEndTime[2],n+.05)),2===e&&(G.laneEndTime[1]=Math.max(G.laneEndTime[1],n+.05),G.laneEndTime[3]=Math.max(G.laneEndTime[3],n+.05)),f.push(e)),I=!0,T++}}I&&(G.lastEpicNoteTime=c),i=i*s.AVG_UPDATE_RATE+u*(1-s.AVG_UPDATE_RATE),o=o*s.AVG_UPDATE_RATE+E*(1-s.AVG_UPDATE_RATE)}if(G.notes.length>0){const e=G.lastEpicNoteTime;if(G.notes=G.notes.filter(t=>t.time<e-.1||t.time===e),!G.notes.find(t=>t.time===e&&0===t.lane)){const t=void 0;IS_MOBILE&&G.notes.find(t=>t.time===e&&1===t.lane)||createNoteFromScan(e,0,!1,"beat")}IS_MOBILE||G.notes.find(t=>t.time===e&&3===t.lane)||createNoteFromScan(e,3,!1,"beat")}}function createNoteFromScan(e,t,n,a){const i=IS_MOBILE?GAME_CONFIG.SPEED.MOBILE_SCALE:1;let o=G.bpm||120;o<GAME_CONFIG.SPEED.MIN_DISPLAY_BPM&&(o=GAME_CONFIG.SPEED.MIN_DISPLAY_BPM);const l=o/120,s=GAME_CONFIG.SPEED.BASE_TRAVEL_TIME/l*i;G.notes.push({lane:t,time:e,spawnTime:e-s,type:a,hit:!1,missed:!1,isLong:n,isHolding:!1,endTime:n?e+.5:e})}async function analyzeBPM(){if(!G.mediaEl||!G.mediaEl.src)return GAME_CONFIG.AUDIO.DEFAULT_BPM;try{const e=await fetch(G.mediaEl.src),t=await e.arrayBuffer(),n=await actx.decodeAudioData(t);await preScanAudio(n);const a=n.getChannelData(0),i=n.sampleRate;let o=[],l=.3;for(let e=0;e<a.length&&e<120*i;e+=100)Math.abs(a[e])>l&&(o.push(e),e+=.2*i);if(o.length<2)return GAME_CONFIG.AUDIO.DEFAULT_BPM;let s=[];for(let e=1;e<o.length;e++)s.push(o[e]-o[e-1]);const c=void 0;let r=60/(s.reduce((e,t)=>e+t)/s.length/i);for(;r<GAME_CONFIG.AUDIO.BPM_MIN;)r*=2;for(;r>GAME_CONFIG.AUDIO.BPM_MAX;)r/=2;return Math.round(r)}catch(e){return GAME_CONFIG.AUDIO.DEFAULT_BPM}}function analyzeAudio(e){if(G.mediaEl.currentTime<1){G.freqDataArray||(G.freqDataArray=new Uint8Array(analyser.frequencyBinCount)),analyser.getByteFrequencyData(G.freqDataArray);let e=0,t=0;for(let t=2;t<10;t++)e+=G.freqDataArray[t];e/=8;for(let e=12;e<160;e++)t+=G.freqDataArray[e];return t/=148,G.prevK=e,G.prevL=t,void 0}if(!analyser||G.paused||!G.playing)return;if(G.mediaEl&&G.mediaEl.duration>0){const t=G.scrollSpeed||1;let n=G.bpm||120;n<GAME_CONFIG.SPEED.MIN_DISPLAY_BPM&&(n=GAME_CONFIG.SPEED.MIN_DISPLAY_BPM);const a=Math.max(.5,n/120),i=IS_MOBILE?GAME_CONFIG.SPEED.MOBILE_SCALE:1,o=GAME_CONFIG.SPEED.BASE_TRAVEL_TIME/(t*a)*i;if(e+o>G.mediaEl.duration-5)return[0,1,2,3].forEach(t=>{G.activeLongNotes[t]&&(G.activeLongNotes[t].endTime=e+o,G.activeLongNotes[t]=null)}),void 0}if(G.lastEpicNoteTime>0&&e>G.lastEpicNoteTime+.1)return[0,1,2,3].forEach(t=>{G.activeLongNotes[t]&&(G.activeLongNotes[t].endTime=e,G.activeLongNotes[t]=null)}),void 0;const t=e=>{if(!IS_MOBILE)return!1;const t=void 0;return(0===e?[1]:1===e?[0,2]:2===e?[1,3]:[2]).some(e=>null!==G.activeLongNotes[e])};void 0===G.globalLastLNTime&&(G.globalLastLNTime=0),void 0===G.lnCooldown&&(G.lnCooldown=[0,0,0,0]),void 0===G.recentNoteCount&&(G.recentNoteCount=0,G.lastDensityUpdate=e),e-G.lastDensityUpdate>.5&&(G.recentNoteCount=Math.max(0,G.recentNoteCount-2),G.lastDensityUpdate=e),G.freqDataArray||(G.freqDataArray=new Uint8Array(analyser.frequencyBinCount)),analyser.getByteFrequencyData(G.freqDataArray);let n=0,a=0;for(let e=2;e<10;e++)n+=G.freqDataArray[e];n/=8;for(let e=12;e<160;e++)a+=G.freqDataArray[e];a/=148,void 0===G.avgK&&(G.avgK=40,G.avgL=30,G.stair=1,G.lastS=0,G.laneT=[0,0,0,0]);const i=GAME_CONFIG.GENERATION,o=n-(G.prevK||0),l=a-(G.prevL||0);G.avgK=G.avgK*i.SMOOTHING+n*(1-i.SMOOTHING),G.avgL=G.avgL*i.SMOOTHING+a*(1-i.SMOOTHING);const s=60/G.bpm/4,c=e%s;if(c>i.GRID_SNAP&&c<s-i.GRID_SNAP)return G.prevK=n,G.prevL=a,void 0;if(e-G.lastS<i.MIN_COOLDOWN)return;const r=n/(G.avgK+1),d=a/(G.avgL+1);let m=!1,u=null;const E=1+.12*G.recentNoteCount,f=G.recentNoteCount<2?.7:1,I=i.SENSITIVITY.KICK.threshold*(1+.05*G.recentNoteCount),T=i.SENSITIVITY.LEAD.threshold*E*f;if((o>I||r>3)&&Math.random()<i.DENSITY_CONTROL.KICK_CHANCE){let n=o>35?0:3;e>G.laneT[n]+.15&&!t(n)&&(spawnNote(e,"beat",n),G.laneT[n]=e+.18,m=!0,G.recentNoteCount+=.5,u=n)}if((l>T||d>1.02)&&Math.random()<i.DENSITY_CONTROL.MELODY_CHANCE)if(IS_MOBILE){let n=Math.random()<.1&&d>1.8;if(null!==u&&(n=!1),n){const n=[[0,3],[0,2],[1,3]],a=n[Math.floor(Math.random()*n.length)];let i=a[0],o=a[1];e>G.laneT[i]+.05&&e>G.laneT[o]+.05&&!t(i)&&!t(o)&&(spawnNote(e,"melody",i),G.laneT[i]=e+.1,spawnNote(e,"melody",o),G.laneT[o]=e+.1,G.recentNoteCount+=2,m=!0)}else{G.stair=1===G.stair?2:1;let n=G.stair;if(i.FLOW_RULES.ALLOW_OVERFLOW&&Math.random()<i.FLOW_RULES.OVERFLOW_CHANCE&&(n=1===n?0:3),null!==u&&n===u&&(n=0===n?1:3===n?2:(n+1)%4),IS_MOBILE&&null!==u&&Math.abs(u-n)<=1);else if(e>G.laneT[n]+.08&&!t(n)){const t=spawnNote(e,"melody",n);G.laneT[n]=e+.1,m=!0,G.recentNoteCount++;const a=void 0,o=.75*(60/(G.bpm||120)),l=i.LONG_NOTE_RULES.STABILITY_REQUIRED*(G.avgL>100?.85:1),s=e>(G.lnCooldown[n]||0),c=e>G.globalLastLNTime+o;null===u&&d>l&&Math.random()<i.LONG_NOTE_RULES.CHANCE&&s&&c&&(t.maxLifeTime=e+1.2,G.activeLongNotes[n]=t,G.globalLastLNTime=e)}}}else{G.stair=1===G.stair?2:1;let n=G.stair;if(i.FLOW_RULES.ALLOW_OVERFLOW&&Math.random()<i.FLOW_RULES.OVERFLOW_CHANCE&&(n=1===n?0:3),e>G.laneT[n]+.08&&!t(n)){const a=spawnNote(e,"melody",n);G.laneT[n]=e+.1,m=!0,G.recentNoteCount++;let o=d>2.2?.016:.003;if(Math.random()<o){let a=0===n?3:3===n?0:1===n?2:1;e>G.laneT[a]+.05&&!t(a)&&(spawnNote(e,"melody",a),G.laneT[a]=e+.1,G.recentNoteCount++)}const l=void 0,s=.75*(60/(G.bpm||120)),c=i.LONG_NOTE_RULES.STABILITY_REQUIRED*(G.avgL>100?.85:1),r=e>(G.lnCooldown[n]||0),u=e>G.globalLastLNTime+s;d>c&&Math.random()<i.LONG_NOTE_RULES.CHANCE&&r&&u&&(a.maxLifeTime=e+1.2,G.activeLongNotes[n]=a,G.globalLastLNTime=e)}}m&&(G.lastS=e),[0,1,2,3].forEach(t=>{let n=G.activeLongNotes[t];if(!n)return;let a=0===t||3===t?r:d,i=G.bpm||120;i<GAME_CONFIG.SPEED.MIN_DISPLAY_BPM&&(i=GAME_CONFIG.SPEED.MIN_DISPLAY_BPM);const o=i/120,l=GAME_CONFIG.SPEED.BASE_TRAVEL_TIME/o;if(a>.85&&e<(n.maxLifeTime||e+1)){if(n.endTime=e+l+.2,n.isLong=!0,G.laneT[t]=n.endTime,IS_MOBILE){const e=void 0;(0===t?[1]:1===t?[0,2]:2===t?[1,3]:[2]).forEach(e=>G.laneT[e]=Math.max(G.laneT[e],n.endTime+.2))}}else G.lnCooldown[t]=e+1.5,G.activeLongNotes[t]=null}),G.prevK=n,G.prevL=a}function loop(){if(!G.playing||G.paused)return;const e=G.mediaEl.currentTime,t=performance.now();void 0===G.lastAudioSync&&(G.lastAudioSync=e,G.lastSyncTimestamp=t),e!==G.lastAudioSync&&(G.lastAudioSync=e,G.lastSyncTimestamp=t);const n=e+(t-G.lastSyncTimestamp)/1e3,a=60/G.bpm,i=void 0;n%a/a<.05&&(G.lineGlow=Math.max(G.lineGlow,.5));const o=G.mediaEl.duration;if(o>0&&(document.getElementById("song-progress-bar").style.transform=`scaleX(${n/o})`),G.isFever){if(G.fever<=0)endFeverEffect();else{let e=G.fever/100;const t=GAME_CONFIG.FEVER.FILTER_MIN_FREQ,n=void 0,a=t+(GAME_CONFIG.FEVER.FILTER_MAX_FREQ-t)*(1-e);feverFilter.frequency.setTargetAtTime(a,actx.currentTime,.05),G.fever-=GAME_CONFIG.FEVER.DRAIN_RATE}updateHUD()}n-G.lastAnalysisTime>.033&&(analyzeAudio(n),G.lastAnalysisTime=n),ctx.clearRect(0,0,cvs.width,cvs.height),G.isFever&&(ctx.save(),ctx.globalCompositeOperation="source-over",ctx.fillStyle=G.cachedGradients.fever,ctx.fillRect(0,0,cvs.width,JUDGE_Y),ctx.restore());const l=G.isFever?GAME_CONFIG.SPEED.FEVER_ACCEL:1;void 0===G.speedLerp&&(G.speedLerp=l),G.speedLerp+=.05*(l-G.speedLerp),G.currentSpeed=G.baseSpeed*G.speedLerp*(G.scrollSpeed||1),G.currentSpeed*=.85;const s=G.currentSpeed/(IS_MOBILE?GAME_CONFIG.SPEED.MOBILE_SCALE:1),c=void 0,r=GAME_CONFIG.COLORS.LANE_WIDTH*SCALE_X,d=8e3,m=(JUDGE_Y+d)/(1e3*s),u=2;for(let e=G.notes.length-1;e>=0;e--){const t=G.notes[e];if(t.isDead)continue;const a=t.time-(n+G.audioOffset),i=(t.isLong?t.endTime:t.time)-(n+G.audioOffset);if(a>m)continue;if(t.isLong){if(i<-2&&!t.isHolding){t.isDead=!0;continue}}else if(a<-2){t.isDead=!0;continue}const o=void 0,l=i;let c=JUDGE_Y-1e3*a*s,d=JUDGE_Y-1e3*l*s,u=1;const E=GAME_CONFIG.COLORS.NOTE_LANES[t.lane];if(t.missed)u=.4;else if(t.hit)if(t.isLong&&t.isHolding)c=JUDGE_Y;else{const e=.5,a=n-(t.hitTime||n);if(a>e){t.isDead=!0;continue}u=Math.pow(1-a/e,1.5),c=JUDGE_Y}else c>JUDGE_Y&&!t.hit&&!t.isLong&&(u=.4);if(ctx.globalAlpha=u,t.isLong){let e=t.missed?.3:t.isHolding?.8+.2*Math.sin(.02*Date.now()):.7;ctx.globalAlpha=e*u,ctx.fillStyle=E;const n=d,a=c-d;a>0&&ctx.fillRect(t.lane*r+5*SCALE_X,n,r-10*SCALE_X,a)}if(c<cvs.height+200&&d>-8e3&&(!t.isLong||!t.isHolding)){ctx.fillStyle=E;let e=1;if(t.hit&&!t.missed){const a=void 0;e=1+1.5*(n-(t.hitTime||n))}const a=(r-10*SCALE_X)*e,i=GAME_CONFIG.COLORS.NOTE_HEIGHT*(t.hit&&!t.missed?e:1),o=t.lane*r+(r-a)/2;ctx.fillRect(o,c-i/2,a,i),ctx.fillStyle="#ffffff";const l=4*(t.hit&&!t.missed?e:1);ctx.fillRect(o,c-l/2,a,l)}ctx.globalAlpha=1,t.isLong&&t.isHolding&&n+G.audioOffset>t.endTime+GAME_CONFIG.JUDGEMENT.WINDOW_GOOD&&(t.isHolding=!1,t.missed=!0,triggerJudge("MISS",t.lane));const f=void 0;l<(G.isFever?-.12:-.21)&&!t.hit&&(t.hit=!0,t.missed=!0,triggerJudge("MISS",t.lane)),d>cvs.height+500&&(t.isDead=!0)}ctx.save(),G.lineGlow*=.9;const E=20+60*G.lineGlow;ctx.fillStyle=G.lineGlow>.7?`rgb(255, ${50+100*G.lineGlow}, ${50+100*G.lineGlow})`:GAME_CONFIG.COLORS.NEON_RED,ctx.globalAlpha=.8,ctx.fillRect(0,JUDGE_Y-4,cvs.width,22),G.lineGlow>.4&&(ctx.fillStyle="#ffffff",ctx.globalAlpha=.5*G.lineGlow,IS_MOBILE||(ctx.shadowColor="#ffffff"),ctx.fillRect(0,JUDGE_Y-4,cvs.width,22)),ctx.restore(),drawFX(),G.animId=requestAnimationFrame(loop)}function drawFX(){ctx.save();const e=GAME_CONFIG.COLORS.LANE_WIDTH*SCALE_X;for(let t=0;t<4;t++)if(G.beams[t]>0){const n=.8*G.beams[t];ctx.fillStyle=G.cachedGradients.beams[t],ctx.globalAlpha=n,ctx.fillRect(t*e+5*SCALE_X,0,e-10*SCALE_X,JUDGE_Y),G.beams[t]*=.85,G.beams[t]<.01&&(G.beams[t]=0)}for(const e of G.particlePool)if(e.active)if(e.life-=.05,e.life<=0)e.active=!1;else if(e.isGlow){if(!IS_MOBILE){const t=e.x||0,n=e.y||JUDGE_Y,a=Math.max(.1,400*e.life*SCALE_X),i=ctx.createRadialGradient(t,n,0,t,n,a);i.addColorStop(0,"#ffffff"),i.addColorStop(.2,e.color),i.addColorStop(1,"transparent"),ctx.fillStyle=i,ctx.globalAlpha=.8*e.life,ctx.beginPath(),ctx.arc(t,n,a,0,2*Math.PI),ctx.fill()}}else e.isRing?(ctx.beginPath(),ctx.arc(e.x,e.y,80*(1-e.life)*SCALE_X,0,2*Math.PI),ctx.strokeStyle=e.color,ctx.lineWidth=3*e.life,ctx.globalAlpha=.5*e.life,ctx.stroke()):(e.x+=e.vx*SCALE_X,e.y+=e.vy,ctx.beginPath(),ctx.fillStyle=e.color,ctx.globalAlpha=e.life,ctx.arc(e.x,e.y,(e.size||2)*SCALE_X,0,2*Math.PI),ctx.fill());if(G.judgeTimer>0){void 0===G.judgeScale&&(G.judgeScale=1),G.judgeScale+=.15*(1-G.judgeScale);const e=.2*CH;if(ctx.textAlign="center",ctx.globalAlpha=Math.min(1,2.5*G.judgeTimer),ctx.save(),ctx.translate(CW/2,e),ctx.scale(G.judgeScale,G.judgeScale),ctx.font=`italic 900 ${45*SCALE_X}px 'Segoe UI', sans-serif`,ctx.fillStyle=G.judgeColor,IS_MOBILE||(ctx.shadowColor=G.judgeColor,ctx.shadowBlur=15),ctx.fillText(G.judgeText,0,0),ctx.restore(),G.combo>0){const t=e+70*SCALE_X;ctx.shadowBlur=0,ctx.font=`900 ${75*SCALE_X}px 'Segoe UI', sans-serif`,ctx.fillStyle="#ffffff",ctx.fillText(G.combo,CW/2,t),ctx.font=`bold ${16*SCALE_X}px 'Segoe UI', sans-serif`,ctx.fillStyle="#888888",ctx.fillText("COMBO",CW/2,t+25*SCALE_X)}G.judgeTimer-=.016}ctx.restore()}preRenderSFX(),G.lastAudioTime=0,G.lastSyncTimestamp=performance.now();const KEYS=["d","f","j","k"];function handleInputStart(e,t=!1){if(-1===e)return;G.keysHeld[e]=!0;const n=document.getElementById(`k${e}`);if(n&&n.classList.add("active"),G.beams[e]=1,G.playing&&!G.paused){playSFX(G.isFever?"fever-hit":"hit");const n=G.mediaEl.currentTime,a=void 0,i=n+G.audioOffset,o=GAME_CONFIG.JUDGEMENT.HIT_DETECTION_RANGE*(t?GAME_CONFIG.JUDGEMENT.MOBILE_HIT_WINDOW_SCALE:1),l=G.notes.find(t=>t.lane===e&&!t.hit&&!t.missed&&Math.abs(t.time-i)<=o);if(l){const a=Math.abs(l.time-i),o=GAME_CONFIG.JUDGEMENT,s=t?o.MOBILE_HIT_WINDOW_SCALE:1;if(a>o.WINDOW_GOOD*s)l.hit=!0,l.missed=!0,triggerJudge("MISS",e);else if(l.hit=!0,l.hitTime=n,l.isLong)l.isHolding=!0;else{let t="GOOD";a<o.WINDOW_PERFECT*s?t="PERFECT":a<o.WINDOW_GREAT*s&&(t="GREAT"),triggerJudge(t,e)}}}}function handleInputEnd(e){if(-1!==e){G.keysHeld[e]=!1;const t=G.notes.find(t=>t.lane===e&&t.isLong&&t.isHolding&&!t.processedEnd);if(t){t.isHolding=!1,t.processedEnd=!0;const n=void 0,a=void 0,i=G.mediaEl.currentTime+G.audioOffset,o=Math.abs(t.endTime-i),l=GAME_CONFIG.JUDGEMENT;o<l.WINDOW_PERFECT?triggerJudge("PERFECT",e):o<l.WINDOW_GREAT?triggerJudge("GREAT",e):o<l.WINDOW_GOOD?triggerJudge("GOOD",e):(t.missed=!0,triggerJudge("MISS",e))}const n=document.getElementById(`k${e}`);n&&n.classList.remove("active")}}window.addEventListener("keydown",e=>{if(void 0!==actx&&"suspended"===actx.state&&actx.resume(),G.playing){const t=["Space"," ","d","f","j","k","D","F","J","K"];(t.includes(e.key)||t.includes(e.code))&&e.preventDefault()}if(e.repeat)return;"Escape"===e.key&&(G.paused?resumeGame():togglePause());const t=void 0;handleInputStart(KEYS.indexOf(e.key.toLowerCase()),!1)},{passive:!1}),window.onkeyup=e=>{const t=void 0;handleInputEnd(KEYS.indexOf(e.key.toLowerCase()))},document.addEventListener("gesturestart",e=>e.preventDefault()),document.addEventListener("gesturechange",e=>e.preventDefault()),document.addEventListener("gestureend",e=>e.preventDefault());const touchStage=document.getElementById("gear-stage"),activeTouches={},laneTouchCount=[0,0,0,0],getGameRect=()=>touchStageRect||touchStage.getBoundingClientRect();function getInactiveParticle(){for(let e=0;e<G.particlePool.length;e++)if(!G.particlePool[e].active)return G.particlePool[e];return null}function spawnExplosion(e,t){const n=t||GAME_CONFIG.COLORS.NOTE_LANES[e],a=GAME_CONFIG.COLORS.LANE_WIDTH*SCALE_X,i=e*a+a/2,o=IS_MOBILE?8:15;let l=getInactiveParticle();l&&(l.active=!0,l.x=i,l.y=JUDGE_Y,l.isGlow=!0,l.isRing=!1,l.life=1,l.color=n,l.vx=0,l.vy=0);for(let e=0;e<o;e++){let e=getInactiveParticle();e&&(e.active=!0,e.x=i,e.y=JUDGE_Y,e.isGlow=!1,e.isRing=!1,e.vx=20*(Math.random()-.5),e.vy=15*(Math.random()-1.2),e.life=.7,e.color=n,e.size=3+2*Math.random(),e.decayRate=IS_MOBILE?.08:.05)}let s=getInactiveParticle();s&&(s.active=!0,s.x=i,s.y=JUDGE_Y,s.isGlow=!1,s.isRing=!0,s.life=1,s.color=n,s.vx=0,s.vy=0)}touchStage.addEventListener("touchstart",e=>{e.cancelable&&e.preventDefault();const t=getGameRect();for(let n=0;n<e.changedTouches.length;n++){const a=e.changedTouches[n],i=void 0;if(a.clientY-t.top>.4*t.height){const e=a.clientX-t.left;let n=Math.floor(e/t.width*4);n=Math.max(0,Math.min(3,n)),activeTouches[a.identifier]=n,laneTouchCount[n]++,handleInputStart(n,!0)}}},{passive:!1}),touchStage.addEventListener("touchmove",e=>{e.cancelable&&e.preventDefault();const t=getGameRect();for(let n=0;n<e.changedTouches.length;n++){const a=e.changedTouches[n],i=activeTouches[a.identifier];if(void 0!==i){const e=a.clientX-t.left,n=a.clientY-t.top;let o=Math.floor(e/t.width*4);o=Math.max(0,Math.min(3,o));const l=n>.4*t.height;l&&o!==i?(laneTouchCount[i]--,laneTouchCount[i]<=0&&(laneTouchCount[i]=0,handleInputEnd(i)),activeTouches[a.identifier]=o,laneTouchCount[o]++,handleInputStart(o,!0)):l?l&&-1===i&&(activeTouches[a.identifier]=o,laneTouchCount[o]++,handleInputStart(o,!0)):(laneTouchCount[i]>0&&(laneTouchCount[i]--,0===laneTouchCount[i]&&handleInputEnd(i)),activeTouches[a.identifier]=-1)}}},{passive:!1}),["touchend","touchcancel"].forEach(e=>{touchStage.addEventListener(e,e=>{e.cancelable&&e.preventDefault();for(let t=0;t<e.changedTouches.length;t++){const n=e.changedTouches[t],a=activeTouches[n.identifier];void 0!==a&&-1!==a&&(laneTouchCount[a]--,laneTouchCount[a]<=0&&(laneTouchCount[a]=0,handleInputEnd(a))),delete activeTouches[n.identifier]}},{passive:!1})});const JUDGE_COLORS={PERFECT:"#ffeb3b",GREAT:"#00f3ff",GOOD:"#4caf50",MISS:"#f44336"};function triggerJudge(e,t){const n=GAME_CONFIG.JUDGEMENT,a=JUDGE_COLORS[e]||"#ffffff";G.judgeText=e,G.judgeColor=a,G.judgeTimer=1,G.judgeScale=1.5;const i=void 0!==t?t:0;if("MISS"===e){if(G.lineGlow=0,G.combo=0,G.stats.miss++,G.hp=Math.max(0,G.hp-n.HP_LOSS_MISS),G.failEnabled&&G.hp<=0)return finishGame(!1),void 0;G.isFever&&endFeverEffect()}else{G.lineGlow=1,spawnExplosion(i,a),G.combo++,G.stats[e.toLowerCase()]++,G.stats.maxCombo=Math.max(G.combo,G.stats.maxCombo),"PERFECT"===e?G.hp=Math.min(100,G.hp+n.HP_GAIN_PERFECT):"GREAT"===e?G.hp=Math.min(100,G.hp+n.HP_GAIN_GREAT):"GOOD"===e&&(G.hp=Math.min(100,G.hp+n.HP_GAIN_GOOD));let t="PERFECT"===e?n.SCORE_PERFECT:"GREAT"===e?n.SCORE_GREAT:n.SCORE_GOOD;G.score+=t*(G.isFever?GAME_CONFIG.FEVER.SCORE_MULTIPLIER:1),G.isFever||(G.fever=Math.min(GAME_CONFIG.FEVER.MAX_VALUE,G.fever+GAME_CONFIG.FEVER.GAIN_PER_HIT),G.fever>=GAME_CONFIG.FEVER.MAX_VALUE&&startFever())}updateHUD()}function startFever(){G.isFever=!0,updateHUD(),playSFX("fever-entry"),feverFilter.frequency.setTargetAtTime(800,actx.currentTime,.05),feverBassNode&&feverBassNode.gain.setTargetAtTime(GAME_CONFIG.FEVER.BASS_GAIN,actx.currentTime,.1),document.getElementById("gear-stage").classList.add("fever-mode-active"),document.getElementById("fever-txt").style.opacity=1}function endFeverEffect(){G.isFever=!1,G.fever=0,feverFilter.frequency.setTargetAtTime(GAME_CONFIG.FEVER.FILTER_MAX_FREQ,actx.currentTime,.1),feverBassNode&&feverBassNode.gain.setTargetAtTime(0,actx.currentTime,.1);const e=document.getElementById("gear-stage");e&&(e.classList.remove("fever-mode-active"),e.style.transform="scale(1.0)"),document.getElementById("fever-txt").style.opacity=0,updateHUD()}function updateHUD(){G.hp!==G.lastHudUpdate.hp&&(document.getElementById("hp-fill").style.transform=`scaleY(${G.hp/100})`,G.lastHudUpdate.hp=G.hp),G.fever!==G.lastHudUpdate.fever&&(document.getElementById("fever-fill").style.transform=`scaleY(${G.fever/100})`,G.lastHudUpdate.fever=G.fever),G.combo!==G.lastHudUpdate.combo&&(G.lastHudUpdate.combo=G.combo)}function playSFX(e,t=1){const n=actx.currentTime;if("suspended"===actx.state&&actx.resume(),"hit"===e||"fever-hit"===e){const a="fever-hit"===e?sfxBuffers.feverHit:sfxBuffers.hit;if(a){const e=actx.createBufferSource();e.buffer=a;const i=actx.createGain();i.gain.value=t,e.connect(i),i.connect(sfxBus),e.start(n)}else{const a=actx.createOscillator(),i=actx.createGain(),o="fever-hit"===e;a.type="triangle";const l=o?150:200,s=o?20:30,c=o?.2:.1;a.frequency.setValueAtTime(l,n),a.frequency.exponentialRampToValueAtTime(s,n+c),i.gain.setValueAtTime(.8*t,n),i.gain.exponentialRampToValueAtTime(.001,n+c),a.connect(i),i.connect(sfxBus),a.start(n),a.stop(n+c)}}else if("fever-entry"===e){if(!noiseBuffer)return;const e=actx.createBufferSource();e.buffer=noiseBuffer;const t=actx.createBiquadFilter();t.type="lowpass",t.frequency.setValueAtTime(200,n),t.frequency.exponentialRampToValueAtTime(5e3,n+.8);const a=actx.createGain();a.gain.setValueAtTime(0,n),a.gain.linearRampToValueAtTime(1,n+.6),a.gain.linearRampToValueAtTime(0,n+1),e.connect(t),t.connect(a),a.connect(sfxBus),e.start(n);const i=document.getElementById("gear-stage");i&&(i.classList.add("fever-shake"),setTimeout(()=>i.classList.remove("fever-shake"),1e3))}}function playMenuImpact(){if(!actx)return;const e=actx.currentTime,t=actx.createOscillator(),n=actx.createGain();t.connect(n),n.connect(masterGainNode),t.type="triangle",t.frequency.setValueAtTime(150,e),t.frequency.exponentialRampToValueAtTime(.01,e+.3),n.gain.setValueAtTime(.5,e),n.gain.exponentialRampToValueAtTime(.01,e+.3),t.start(e),t.stop(e+.3)}function handleBoxClick(e,t){document.getElementById("inp-"+t).click()}async function loadMedia(e,t){if(!e)return;G.mediaEl&&(G.mediaEl.pause(),G.mediaEl.src="",G.mediaEl.load()),G.mediaEl=null;const n=document.getElementById("bg-video");n.style.opacity=0,n.src="",document.getElementById("box-audio").classList.remove("selected"),document.getElementById("box-video").classList.remove("selected"),document.getElementById("name-audio").innerText="Select File",document.getElementById("name-video").innerText="Select File",document.getElementById("inp-"+("audio"===t?"video":"audio")).value="","suspended"===actx.state&&await actx.resume();const a=URL.createObjectURL(e),i=document.getElementById("song-name-text");if(i&&(i.innerText=e.name.replace(/\.[^/.]+$/,"").toUpperCase()),document.getElementById("box-"+t).classList.add("selected"),document.getElementById("name-"+t).innerText=e.name,"video"===t)n.src=a,n.load(),n.style.opacity=1,G.mediaEl=n,G.mediaType="video";else{const e=new Audio;e.src=a,e.crossOrigin="anonymous",G.mediaEl=e,G.mediaType="audio"}try{const t=await e.arrayBuffer(),n=await actx.decodeAudioData(t);await preScanAudio(n),G.bpm=await analyzeBPM()}catch(e){void 0,G.bpm=GAME_CONFIG.AUDIO.DEFAULT_BPM}G.mediaEl.loop=!1,G.mediaEl.addEventListener("ended",()=>{setTimeout(()=>{G.playing&&!G.paused&&finishGame(!0)},2500)}),document.getElementById("diff-opt").style.display="block"}async function preInitGame(e){const t=document.getElementById("difficulty-display");if(t){t.style.display="block";const n=" - "+G.scrollSpeed.toFixed(2)+"x";e<=.7?(t.innerText="EASY"+n,t.style.color="#00ff00",t.style.textShadow="0 0 10px #00ff00"):e<=1?(t.innerText="NORMAL"+n,t.style.color="var(--neon-blue)",t.style.textShadow="0 0 10px var(--neon-blue)"):(t.innerText="HARD"+n,t.style.color="var(--neon-pink)",t.style.textShadow="0 0 10px var(--neon-pink)")}document.activeElement instanceof HTMLElement&&document.activeElement.blur(),window.focus(),document.body.focus(),"suspended"===actx.state&&await actx.resume(),G.diff=e,G.failEnabled=document.getElementById("chk-fail").checked,G.bpm=await analyzeBPM(),G.spawnFilterRate=1.1,G.spawnFilterRate=e<=.7?G.bpm<115?.5:.6:e<=1?G.bpm<115?.7:.8:1.3,G.baseSpeed=G.bpm/120*1;try{feverFilter.disconnect()}catch(e){}if(feverBassNode=actx.createBiquadFilter(),feverBassNode.type="lowshelf",feverBassNode.frequency.value=200,feverBassNode.gain.value=0,mainSource)try{mainSource.disconnect()}catch(e){}try{"video"===G.mediaType?(G.videoSourceNode||(G.videoSourceNode=actx.createMediaElementSource(G.mediaEl)),mainSource=G.videoSourceNode):mainSource=actx.createMediaElementSource(G.mediaEl),mainSource.connect(analyser),analyser.connect(feverFilter),feverFilter.connect(feverBassNode),feverBassNode.connect(masterGainNode)}catch(e){}document.getElementById("menu-screen").classList.add("hidden"),"running"!==actx.state&&await actx.resume(),startCountdown()}function startCountdown(){"suspended"===actx.state&&actx.resume(),G.screen="COUNTDOWN";const e=document.getElementById("volume-slider");if(e&&masterGainNode){const t=parseFloat(e.value);G.volume=t,masterGainNode.gain.cancelScheduledValues(actx.currentTime),masterGainNode.gain.setValueAtTime(t,actx.currentTime)}G.notes.forEach(e=>e.isDead=!0),G.notes=[],G.smoothTime=0,G.mediaEl&&(G.mediaEl.currentTime=0);const t=document.getElementById("cd-num");document.getElementById("cd-screen").classList.remove("hidden");const n=document.getElementById("menu-bgm");if(n){G.menuFadeTimer&&clearInterval(G.menuFadeTimer);let e=menuGainNode?menuGainNode.gain.value:n.volume,t=20;const a=setInterval(()=>{e=Math.max(0,e-.05),menuGainNode?menuGainNode.gain.value=e:n.volume=e,t--,(e<=0||t<=0)&&(menuGainNode?menuGainNode.gain.value=0:n.volume=0,n.pause(),n.currentTime=0,clearInterval(a))},30)}const a=setInterval(()=>{window.focus()},500);let i=3;t.innerText=i;let o=setInterval(()=>{if(i--,2===i){for(let e=0;e<30;e++)G.notes.push({lane:0,time:0,isDead:!0});playSFX("hit",.001)}1===i&&G.mediaEl&&(G.mediaEl.muted=!0,G.mediaEl.volume=0,G.mediaEl.play().then(()=>{setTimeout(()=>{G.mediaEl.pause(),G.mediaEl.currentTime=0,G.mediaEl.muted=!1,G.mediaEl.volume=1},400)}).catch(e=>{})),i>0?t.innerText=i:0===i?t.innerText="GO!":(clearInterval(o),clearInterval(a),document.getElementById("cd-screen").classList.add("hidden"),window.focus(),document.activeElement&&document.activeElement.blur(),document.body.focus(),initGameValues(),setTimeout(()=>{startGame()},50))},1e3)}function initGameValues(){if(G.hp=100,G.score=0,G.combo=0,G.maxCombo=0,G.fever=0,G.isFever=!1,G.playing=!1,G.notes=[],G.particles=[],G.beams=[0,0,0,0],G.judgeTimer=0,G.lineGlow=0,G.particlePool&&G.particlePool.forEach(e=>e.active=!1),G.keysHeld=[!1,!1,!1,!1],G.activeLongNotes=[null,null,null,null],void 0!==laneTouchCount&&laneTouchCount.fill(0),void 0!==activeTouches)for(let e in activeTouches)delete activeTouches[e];G.smoothTime=0,G.lastFrameTime=0,G.lastAudioSync=void 0,G.lastSyncTimestamp=performance.now(),G.lastAnalysisTime=0,G.lastS=0,G.laneT=[0,0,0,0],G.laneEndTime=[0,0,0,0],G.lnCooldown=[0,0,0,0],G.recentNoteCount=0,G.lastDensityUpdate=0,G.stats={perfect:0,great:0,good:0,miss:0,maxCombo:0},G.speedLerp=1,updateHUD();const e=document.getElementById("judge-txt");e&&(e.innerText="",e.className="",e.style.opacity="0");const t=document.getElementById("combo-val");t&&(t.innerText="");const n=document.getElementById("combo-txt");n&&(n.style.opacity="0"),document.getElementById("gear-stage").classList.remove("fever-mode-active"),document.getElementById("fever-txt").style.opacity=0;const a=document.getElementById("combo-box");a&&a.classList.remove("show-combo");const i=document.getElementById("song-progress-bar");i&&(i.style.transform="scaleX(0)")}function startGame(){initGameValues(),G.screen="PLAYING",G.playing=!0,G.paused=!1,resizeCanvas(),G.mediaEl&&(G.mediaEl.currentTime=0,G.mediaEl.muted=!1,G.mediaEl.play().catch(e=>{})),G.lastFrameTime=performance.now(),G.animId&&cancelAnimationFrame(G.animId),G.animId=requestAnimationFrame(loop)}function togglePause(){"PLAYING"!==G.screen&&"PAUSED"!==G.screen||G.paused||(G.paused=!0,G.mediaEl.pause(),cancelAnimationFrame(G.animId),document.getElementById("pause-screen").classList.remove("hidden"))}function resumeGame(){document.getElementById("pause-screen").classList.add("hidden");const e=document.getElementById("cd-screen"),t=document.getElementById("cd-num");e.classList.remove("hidden"),e.style.background="rgba(0,0,0,0.5)",e.style.backdropFilter="blur(2px)",e.style.webkitBackdropFilter="blur(2px)";let n=3;t.innerText=n;const a=setInterval(()=>{n--,n>0?t.innerText=n:(clearInterval(a),e.classList.add("hidden"),e.style.background="",e.style.backdropFilter="",e.style.webkitBackdropFilter="",G.paused=!1,G.mediaEl.play(),G.lastFrameTime=performance.now(),G.smoothTime=G.mediaEl.currentTime,loop())},1e3)}function retryGame(){G.paused=!1,cancelAnimationFrame(G.animId),G.mediaEl&&(G.mediaEl.pause(),G.mediaEl.currentTime=0),stopResultMusic(),initGameValues(),document.getElementById("pause-screen").classList.add("hidden"),document.getElementById("result-screen").classList.add("hidden");const e=document.getElementById("difficulty-display");e&&(e.style.display="block"),window.focus(),document.activeElement&&document.activeElement.blur(),startCountdown()}function backToMenu(){G.playing=!1,G.paused=!1,G.animId&&cancelAnimationFrame(G.animId),G.mediaEl&&(G.mediaEl.pause(),G.mediaEl.currentTime=0),stopResultMusic(),initGameValues();const e=void 0;["judge-txt","combo-val","combo-txt","fever-txt"].forEach(e=>{const t=document.getElementById(e);t&&(t.innerText="",t.style.opacity="0",t.className="")}),ctx&&ctx.clearRect(0,0,cvs.width,cvs.height),document.getElementById("pause-screen").classList.add("hidden"),document.getElementById("result-screen").classList.add("hidden"),document.getElementById("cd-screen").classList.add("hidden"),document.getElementById("gear-stage").classList.remove("fever-mode-active"),document.getElementById("diff-opt").style.display="none",document.getElementById("box-audio").classList.remove("selected"),document.getElementById("box-video").classList.remove("selected"),document.getElementById("name-audio").innerText="Select File",document.getElementById("name-video").innerText="Select File",document.getElementById("inp-audio").value="",document.getElementById("inp-video").value="",G.screen="MENU",document.getElementById("menu-screen").classList.remove("hidden"),document.getElementById("start-overlay").style.display="none",document.getElementById("menu-main-content").style.visibility="visible",tryPlayMenuBgm()}function playResultMusicRobust(e){const t=e?document.getElementById("bgm-clear"):document.getElementById("bgm-fail");let n=null;if(e?(clearSource||(clearSource=actx.createMediaElementSource(t),clearGain=actx.createGain(),clearSource.connect(clearGain),clearGain.connect(masterGainNode)),n=clearGain):(failSource||(failSource=actx.createMediaElementSource(t),failGain=actx.createGain(),failSource.connect(failGain),failGain.connect(masterGainNode)),n=failGain),n){n.gain.setValueAtTime(0,actx.currentTime),t.currentTime=0,t.loop=!0,t.load();const e=t.play();void 0!==e&&e.then(()=>{let e=0;const t=.4;resultFadeTimer&&clearInterval(resultFadeTimer),resultFadeTimer=setInterval(()=>{e+=.02,e>=t?(n.gain.value=t,clearInterval(resultFadeTimer)):n.gain.value=e},50)}).catch(e=>{})}}function stopResultMusic(){resultFadeTimer&&clearInterval(resultFadeTimer);const e=document.getElementById("bgm-clear"),t=document.getElementById("bgm-fail");e&&(e.pause(),e.currentTime=0),t&&(t.pause(),t.currentTime=0)}function finishGame(e){G.playing=!1,G.screen="RESULT",cancelAnimationFrame(G.animId),G.mediaEl.pause(),playResultMusicRobust(e);const t=void 0;document.getElementById("result-screen").classList.remove("hidden");const n=document.getElementById("res-rank"),a=document.getElementById("res-title"),i=document.getElementById("res-fc");i&&i.classList.add("hidden"),document.getElementById("st-perf").innerText=G.stats.perfect,document.getElementById("st-great").innerText=G.stats.great,document.getElementById("st-good").innerText=G.stats.good,document.getElementById("st-miss").innerText=G.stats.miss,document.getElementById("res-score").innerText=Math.floor(G.score);const o=G.stats.perfect+G.stats.great+G.stats.good+G.stats.miss;if(o>0&&(updateStatBar("bar-perf",G.stats.perfect,o),updateStatBar("bar-great",G.stats.great,o),updateStatBar("bar-good",G.stats.good,o),updateStatBar("bar-miss",G.stats.miss,o)),e){a.innerText="STAGE CLEAR";let e=1*G.stats.perfect+.7*G.stats.great+.3*G.stats.good,t=o>0?e/o:0,l="D",s="#888888";t>=.99?(l="SSS",s="#ffffff"):t>=.96?(l="SS",s="#ffcc00"):t>=.9?(l="S",s="#00f3ff"):t>=.8?(l="A",s="#00ff00"):t>=.7?(l="B",s="#ffff00"):t>=.6&&(l="C",s="#ffaa00"),n.innerText=l,n.style.color=s,n.style.textShadow="SSS"===l?"0 0 20px #fff, 0 0 40px #ffcc00":`0 0 20px ${s}, 0 0 40px ${s}`,0===G.stats.miss&&o>0&&i&&i.classList.remove("hidden")}else a.innerText="GAME OVER",n.innerText="F",n.style.color="#ff3333",n.style.textShadow="0 0 20px #ff3333, 0 0 40px #ff3333";const l=document.getElementById("difficulty-display");l&&(l.style.display="none")}function updateStatBar(e,t,n){const a=document.getElementById(e);a&&(a.style.width=t/n*100+"%")}function changeSpeed(e){const t=GAME_CONFIG.SPEED.OPTIONS;G.scrollSpeedIndex+=e,G.scrollSpeedIndex<0&&(G.scrollSpeedIndex=0),G.scrollSpeedIndex>=t.length&&(G.scrollSpeedIndex=t.length-1),G.scrollSpeed=t[G.scrollSpeedIndex];const n=document.getElementById("speed-display");n&&(n.innerText=G.scrollSpeed.toFixed(2)+"x")}function tryPlayMenuBgm(){const e=document.getElementById("menu-bgm");if(e&&"MENU"===G.screen){const t=.24;menuGainNode||(menuSource=actx.createMediaElementSource(e),menuGainNode=actx.createGain(),menuSource.connect(menuGainNode),menuGainNode.connect(masterGainNode)),G.menuFadeTimer&&clearInterval(G.menuFadeTimer),menuGainNode.gain.setValueAtTime(0,actx.currentTime),e.loop=!0;const n=e.play();void 0!==n&&n.then(()=>{G.menuFadeTimer=setInterval(()=>{let e=menuGainNode.gain.value;e<t?menuGainNode.gain.value=Math.min(t,e+.02):clearInterval(G.menuFadeTimer)},100)}).catch(e=>{void 0})}}G.particlePool=Array.from({length:500},()=>({active:!1,x:0,y:0,vx:0,vy:0,life:0,color:"",size:0,isGlow:!1,isRing:!1})),document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("start-overlay"),t=document.getElementById("menu-main-content"),n=document.getElementById("menu-bgm"),a=IS_MOBILE||"MacIntel"===navigator.platform&&navigator.maxTouchPoints>1,i=document.getElementById("volume-slider"),o=document.getElementById("volume-display"),l=document.getElementById("offset-slider"),s=document.getElementById("offset-display");l&&s&&(l.value=0,s.innerText="0.000s",l.addEventListener("input",e=>{const t=parseFloat(e.target.value);G.userOffset=t,G.audioOffset=G.baseOffset+G.userOffset;const n=t>0?"+":"";s.innerText=n+t.toFixed(3)+"s"})),i.addEventListener("input",e=>{const t=parseFloat(e.target.value);G.volume=t,masterGainNode.gain.cancelScheduledValues(actx.currentTime),masterGainNode.gain.linearRampToValueAtTime(t,actx.currentTime+.05),o.innerText=Math.round(100*t)+"%"}),e&&(e.onclick=()=>{e.style.display="none",t.style.visibility="visible","suspended"===actx.state&&actx.resume(),["bgm-clear","bgm-fail"].forEach(e=>{const t=document.getElementById(e);t&&(t.muted=!0,t.play().then(()=>{t.pause(),t.currentTime=0,t.muted=!1}).catch(()=>{}))}),tryPlayMenuBgm()})});
</script>
</body>
</html>